# Technologies

This has been primarily written in d3.js, but Bootstrap has also been used for the infobox popovers (and Bootstrap requires jQuery).

libraries:
 * lodash - utility functions
 * d3.promise.js - adds promises to d3's file reading functions
 * bootstrap - used for the popover functionality
 * jquery - required for bootstrap.

# Design patterns

The d3 components have been written using Mike Bostock's [reusable charts pattern](https://bost.ocks.org/mike/chart/). The non-d3 objects have been written using closure functions with getters and setters i.e.:

	GENEMAP.Person = function(name, age) {
	  var my = {};

	  var privateFn = function() { ... }

	  my.publicFn = function(a, b, c) { ...}

	  my.age = function(value) {
		  if (!arguments.length) return age;
		  age = value;
		  return my;
	  }

	  return my;	  
	}

This was to keep them similar to the d3 objects. If the number of these objects increase it is recommended to switch using a prototype constructor pattern to avoid the overhead of duplicated function objects.

I've tried to use a global module `var GENEMAP = GENEMAP || {};` and attached all the object to this module but I've not used the module pattern to isolate the dependancies of each object. This is something that may be neccesary as the codebase grows.


# Layout

The map is drawn within a contained element, the id of which has to be passed to the .draw() method.

The basic constructed layout is


   - The map creates its own SVG element to contain the drawing
		zoom window - This is a wrapper that has the d3 zoom functionality added to it
			outline - This draws the document outline and sets the backgorund color
			annotation-container - This contains the annotations for genes and QTLS
			chromosome-container - This contains the chromosomes rectangles and colored bands.
	<popover markup> - The popover HTML is added after the SVG container by the bootstrap code

This layout is created by the genemap.js code.

The annotation container contents holds the gene and qtl annotations and is genereated by the annotations.js code. This is included before the chromosome container because the lines for the annotations are drawn under the chromosome to make sure there is no gap between the edge of the chromosome and the start of the line. The structure is:

	g.annotation-group - a group for the annotations of a particular chromosome
		gene_annotation - a list of gene annotations for the chromosome (if any)
			line - a line at the midpoint of the annotation
			polygon - the end marker of the annotation
			text - the name of the gene annotated (not always shown)
		qtl_annotation - a list of qtl annotations for the chromosome
			top-line
			bottom-line
			qtl-selector - the colored rectangle indicating the qtl region
			text - the description of the QTL

The annotation-group is positioned to the right of the chromosome it annotates. The lines used in the annotations actually start at a -ve position so they are drawn under the chromosomes.

The chromosome container contents is generated by the chromosome.js code and has the following structure:

	g.chormosome - a group for each crhomosome defined
		defs
			mask - the mask used for this chromosome
		text - the top label of the chromosome
		background - sets the white backgorund
		bands-container - contains the bands and uses the mask
			bands - a collection of colored rectangular bands
		outline - the black outline to the chromosome

The bands themselves are drawn as a stack of rectangles, to achieve the rounded corners a rounded rectanlge mask is defined and applied to the bands container. To get the black outline another rounded rectangle is drawn over the top of the bands container. The background is needed to prevent any annotation lines showing through the middle of the chromosome where there are no bands.



Even tho the chromosomes and annotations share the same data I decided to draw them using separate components to spimplify the individual components.

# Data processing

The data is read from one or two XML files.
It is then processed by the processor, this alters the colors and combines the data into a single genome object.

	genome
		chromosomes
			annotations
				genes
				qtls
			bands
				start
				midpoint
				end
				color

#Layout

This genome object is then decorated by the layout object to also include information about where the different parts of the map should be positioned.


	genome
		chromosomes
			.height
			.width
			.annotationWidth
			annotations
				genes
				qtls
			bands
				start
				midpoint
				end
				color



#infobox

The infoboxes are the popovers that appear when the annotations are clicked. They are twitter bootstrap popovers that are triggered on click (as opposed to hover). To dismiss them when something else is clicked there is a click handler on the html element that clears all popovers.

# namespaced bootstrap

To avoid having to use bootstrap's css on the entire site I've generated a customised version of the bootstrap css based on the answer to a question on [Stack Overflow](http://stackoverflow.com/questions/13966259/how-to-namespace-twitter-bootstrap-so-styles-dont-conflict).

This was compiles using [WinLess](http://winless.org/) although any Less compiler should work.

# npm and bower

To manage the development dependencies npm is used and bower is used for the libraries used at runtime. As this is a only a browser based component there should be no non-development dependencies installed by npm.

After checking out a copy of the source code you will need to run in the `GeneMap` directory:

    npm install
    bower install

This should automatically install all the dependancies.

# gulp

To automate development tasks `gulp` is used. This should be installed when `npm install` is run. To get a list of all the tasks run the `gulp` command in the `GeneMap` direcotry.

The main development tasks are:
 * *serve-dev* start the development server on port 8080
 * *optimise* build the combined & minified JavaScript and CSS files placing them into the `dist` folder
 * *watch* watches for changes to the .less files and automatically re-compiles the temporary .css files in the `.tmp` directory.
 * *inject* injects the dependencies into the index.html file (from bower, src/js and .tmp/css), also re-compiles all the CSS and SVG files.

 All of these configurations are controlled by the `gulpfile.js` and `gulp.config.js` files in the `GeneMap` directory.
